!define(["api","fun","conf","qrcode"],function(e,t,i,n){return document.title=i.title,function(n){"use strict";$(function(){function r(e){var t=new Image;return t.src=e.toDataURL("image/png"),t}var o=i.dev?"/test":"",a="",s="正在获取积分规则，请稍后！",c=function(){var c=this;this.userTicket="",this.sharedTicket=t.getReportQueryString("ticket"),this.initCover=function(){var e=t.getReportQueryString("type");e&&1==e&&$('[data-type="shareCover"]',n).show()},this.testQRCode=function(e){var t=$("#shareQRCodes",n);if(e)$("#qrcodeImg",t).append('<img class="qrCodeImg" id="QRCode" src="'+o+'/build/img/QRCode.jpg" />');else{$("#qrDiv",t).qrcode({render:"canvas",width:t.height(),height:t.height(),text:"https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket="});var i=document.getElementsByTagName("canvas")[0],a=r(i);$("#qrcodeImg",t).append(a)}},this.getQRCode=function(){var t=$("#shareQRCodes",n);e({},{type:"GET",url:"api/qrcode"}).then(function(e){if(e&&0==e.status){c.userTicket=e.data.ticket,$("#qrDiv",t).qrcode({render:"canvas",width:t.height(),height:t.height(),text:"https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket="+(c.sharedTicket?c.sharedTicket:c.userTicket)});var i=document.getElementsByTagName("canvas")[0],n=r(i);$("#qrcodeImg",t).append(n)}else $("#qrcodeImg",t).append('<img class="qrCodeImg" id="QRCode" src="'+o+'/build/img/QRCode.jpg" />')})},this.getQRCodeImg=function(){var e=$("#shareQRCodes",n);$.ajax({type:"GET",url:"api/qrcode",success:function(t){if(t&&0==t.status){c.userTicket=t.data.ticket;var i="https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket="+(c.sharedTicket?c.sharedTicket:c.userTicket);$("#qrcodeImg",e).append('<img class="qrCodeImg" id="QRCode" src="'+i+'" />')}else $("#qrcodeImg",e).append('<img class="qrCodeImg" id="QRCode" src="'+o+'/build/img/QRCode.jpg" />')},error:function(t){if(c.sharedTicket){var i="https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket="+c.sharedTicket;$("#qrcodeImg",e).append('<img class="qrCodeImg" id="QRCode" src="'+i+'" />')}else $("#qrcodeImg",e).append('<img class="qrCodeImg" id="QRCode" src="'+o+'/build/img/QRCode.jpg" />')}})},this.getCredit=function(){e({},{type:"GET",url:"api/text?text_name=credit_rule"}).then(function(e){e&&0==e.status?a=t.formTips(e.data):s="暂无积分规则"})},this.weChatShare=function(){e({url:location.href},{type:"GET",url:"api/js_data"}).then(function(n){if(n&&0==n.status){var r=n.data;wx.config({debug:!1,appId:r.app_id,timestamp:r.timestamp,nonceStr:r.noncestr,signature:r.sign,jsApiList:["onMenuShareAppMessage","onMenuShareTimeline","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","hideMenuItems"]}),wx.error(function(e){t.swal("微信签名失败","error")}),wx.ready(function(){var n=function(n){var r={title:i.title,desc:"SG易乐充,您的充值管家!",link:location.origin+location.pathname+"share?ticket="+c.userTicket,imgUrl:location.origin+o+"/build/img/card.jpg",type:"link",success:function(i){n&&e({},{type:"GET",url:"api/share"}).then(function(e){e&&0==e.status&&t.swal("分享成功","success")})}};return r};wx.onMenuShareAppMessage(n()),wx.onMenuShareTimeline(n(!0)),wx.onMenuShareQQ(n()),wx.onMenuShareWeibo(n()),wx.onMenuShareQZone(n()),wx.hideMenuItems({menuList:["menuItem:openWithQQBrowser","menuItem:openWithSafari","menuItem:copyUrl"]})})}})},this.init=function(){this.getQRCodeImg(),this.getCredit(),this.weChatShare(),this.initCover()}},d=new c;d.init(),$("#showDetail",n).on("click",function(e){return a?void layer.open({title:!1,btn:!1,area:["88%","88%"],anim:4,scrollbar:!1,content:a}):(t.swal(s,"info"),!1)}),$(document).on("click",'[data-type="shareCover"]',function(e){$(e.target).hide()})})}});